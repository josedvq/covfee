"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[340],{9189:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>a});var t=n(4848),i=n(8453);const s={title:"Deploying to a server"},r=void 0,l={id:"deployment",title:"Deploying to a server",description:"Deploying covfee is necessary when you want to make your HITs available to others over the internet.",source:"@site/docs/deployment.mdx",sourceDirName:".",slug:"/deployment",permalink:"/covfee/docs/deployment",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/deployment.mdx",tags:[],version:"current",frontMatter:{title:"Deploying to a server"},sidebar:"docs",previous:{title:"Task Lifecycle and Timers",permalink:"/covfee/docs/timers"},next:{title:"Development install",permalink:"/covfee/docs/development"}},c={},a=[{value:"1. Deployment configuration",id:"1-deployment-configuration",level:2},{value:"Basic configuration",id:"basic-configuration",level:3},{value:"Hosting media files externally",id:"hosting-media-files-externally",level:3},{value:"2. Deployment Installation",id:"2-deployment-installation",level:2},{value:"3. Starting the server",id:"3-starting-the-server",level:2},{value:"Embedded server",id:"embedded-server",level:3},{value:"gunicorn",id:"gunicorn",level:3},{value:"Apache mod_wsgi",id:"apache-mod_wsgi",level:3},{value:"More deployment options",id:"more-deployment-options",level:3},{value:"Restarting covfee",id:"restarting-covfee",level:2}];function d(e){const o={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.p,{children:"Deploying covfee is necessary when you want to make your HITs available to others over the internet."}),"\n",(0,t.jsx)(o.admonition,{type:"info",children:(0,t.jsxs)(o.p,{children:["If you are developing new task interfaces in Typescript it is more convenient to create your HIT specifications locally, deploy covfee, and then run ",(0,t.jsx)(o.code,{children:"covfee make"})," on the deployed instance to initialize your database."]})}),"\n",(0,t.jsx)(o.h2,{id:"1-deployment-configuration",children:"1. Deployment configuration"}),"\n",(0,t.jsxs)(o.p,{children:["covfee reads its configuration from the folder in which it is run (ie. the project folder). When ran in deployment mode, covfee will look for the file ",(0,t.jsx)(o.code,{children:"covfee.deployment.config.py"})," for its configuration."]}),"\n",(0,t.jsx)(o.h3,{id:"basic-configuration",children:"Basic configuration"}),"\n",(0,t.jsx)(o.p,{children:"If you are deploying covfee in a typical server, add a configuration file like the following to your project folder:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:'BASE_URL = "http://my-domain.com:5000"\n\nCOVFEE_SECRET_KEY = "MY_SECRET"\nADMIN_USERNAME = "admin"\nADMIN_PASSWORD = "admin"\n'})}),"\n",(0,t.jsxs)(o.p,{children:["The ",(0,t.jsx)(o.code,{children:"BASE_URL"})," option should point to the address where you plan to serve covfee."]}),"\n",(0,t.jsx)(o.p,{children:"The username and password will be used by covfee to authenticate users of the admin panel. It is therefore important to set them to something secure."}),"\n",(0,t.jsx)(o.h3,{id:"hosting-media-files-externally",children:"Hosting media files externally"}),"\n",(0,t.jsxs)(o.p,{children:["The ",(0,t.jsx)(o.code,{children:"MEDIA_URL"})," option allows you to customize the location of your media files. By default, covfee will serve media files from a folder called ",(0,t.jsx)(o.code,{children:"www"})," in your project folder. Anything in this folder will be made public. If you want to host your media files externally, you can disable this behavior by setting ",(0,t.jsx)(o.code,{children:"MEDIA_SERVER"})," to ",(0,t.jsx)(o.code,{children:"False"})," and pointing ",(0,t.jsx)(o.code,{children:"MEDIA_URL"})," to your files' location:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"MEDIA_URL = 'http://example.com/covfee-media'\nMEDIA_SERVER = False\n"})}),"\n",(0,t.jsx)(o.h2,{id:"2-deployment-installation",children:"2. Deployment Installation"}),"\n",(0,t.jsxs)(o.p,{children:["Start by installing covfee in the server. If you are using a development version / fork follow the ",(0,t.jsx)(o.em,{children:"Setup"})," section of the [Development instructions] to install covfee in the server."]}),"\n",(0,t.jsx)(o.p,{children:"Next, build the schemata and bundles:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"covfee-dev schemata\ncovfee-dev build\n"})}),"\n",(0,t.jsxs)(o.p,{children:["The second step here builds the production bundles (",(0,t.jsx)(o.em,{children:"compiled"})," Javascript) that is served in production. Errors here might indicate problems with your custom task."]}),"\n",(0,t.jsxs)(o.p,{children:["Now run ",(0,t.jsx)(o.strong,{children:"covfee make"})," in the server:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"covfee make tutorial.py --no-launch --deploy\n"})}),"\n",(0,t.jsx)(o.p,{children:"This will initialize the database for deployment without starting the server."}),"\n",(0,t.jsx)(o.h2,{id:"3-starting-the-server",children:"3. Starting the server"}),"\n",(0,t.jsxs)(o.p,{children:["There are several options for starting covfee in deployment. ",(0,t.jsx)(o.strong,{children:"In the server too, it is important covfee is started from the project folder."})]}),"\n",(0,t.jsx)(o.h3,{id:"embedded-server",children:"Embedded server"}),"\n",(0,t.jsxs)(o.p,{children:["Here we use the production-ready embedded server from ",(0,t.jsx)(o.a,{href:"https://flask-socketio.readthedocs.io/en/latest/deployment.html",children:"flask-socketio"})," to start covfee. To run the server you may use:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"covfee start --host 0.0.0.0 --port 80 --deploy\n"})}),"\n",(0,t.jsx)(o.p,{children:"This will serve covfee in deployment mode using the specified host and port."}),"\n",(0,t.jsx)(o.h3,{id:"gunicorn",children:"gunicorn"}),"\n",(0,t.jsx)(o.p,{children:"gunicorn is the most common deployment option for Flask applications. To run covfee using gunicorn:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"gunicorn --worker-class eventlet -w 4 'covfee.server.app:create_app()' --bind 0.0.0.0:5000\n"})}),"\n",(0,t.jsx)(o.h3,{id:"apache-mod_wsgi",children:"Apache mod_wsgi"}),"\n",(0,t.jsxs)(o.p,{children:["covfee can be run under Apache by using ",(0,t.jsx)(o.a,{href:"https://modwsgi.readthedocs.io/en/master/",children:"mod_wsgi"}),". This option can be more involved and is only recommended for advanced users."]}),"\n",(0,t.jsxs)(o.p,{children:["First, ",(0,t.jsx)(o.code,{children:"mod_wsgi"})," must be installed for Python 3:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"sudo apt-get install libapache2-mod-wsgi-py3\n"})}),"\n",(0,t.jsxs)(o.p,{children:["Next, add a file ",(0,t.jsx)(o.code,{children:"covfee.wsgi"})," with the following to your project directory:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"import sys\nimport os\nsys.stdout = sys.stderr\nactivate_this = '/path/to/virtualenv/bin/activate_this.py'\nwith open(activate_this) as file_:\n    exec(file_.read(), dict(__file__=activate_this))\nos.chdir('/path/to/covfee-project')\nfrom covfee.server.app import create_app\napplication = create_app()\n"})}),"\n",(0,t.jsxs)(o.p,{children:["This code will allow Apache to create your app instance. ",(0,t.jsx)(o.code,{children:"/path/to/virtualenv"})," is the path to your virtual environment where covfee is installed."]}),"\n",(0,t.jsx)(o.p,{children:"Finally, Apache must know about your site. For this add lines like the following to your apache site configuration:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:"WSGIDaemonProcess covfee user=me group=me threads=3\nWSGIProcessGroup covfee\nWSGIScriptAlias /covfee /path/to/covfee-project/covfee.wsgi\n"})}),"\n",(0,t.jsxs)(o.p,{children:[(0,t.jsx)(o.code,{children:"WSGIScriptAlias"})," must point to the ",(0,t.jsx)(o.code,{children:"covfee.wsgi"})," file you created in the previous step. The first parameter ",(0,t.jsx)(o.code,{children:"/covfee"})," is the url path under which covfee will be accesible."]}),"\n",(0,t.jsx)(o.h3,{id:"more-deployment-options",children:"More deployment options"}),"\n",(0,t.jsxs)(o.p,{children:["Covfee is built with Flask and is therefore easy to deploy using any of the options supported by Flask. Take a look at the ",(0,t.jsx)(o.a,{href:"https://flask.palletsprojects.com/en/1.1.x/deploying/",children:"Flask deployment options"})," for more."]}),"\n",(0,t.jsx)(o.h2,{id:"restarting-covfee",children:"Restarting covfee"}),"\n",(0,t.jsxs)(o.p,{children:["Covfee can be safely stopped and started using any of the approaches above. Beware of the use of ",(0,t.jsx)(o.code,{children:"covfee make"})," in production, as the ",(0,t.jsx)(o.code,{children:"--force"})," option will overwrite the entire database, potentially causing data loss.\nIn its current form covfee does not allow modification of the task specification once it has been moved to production. HITs can be duplicated using the admin panel to collect more data or deal with failed HITs, but the specification of a HIT cannot be changed without re-creating the database."]})]})}function h(e={}){const{wrapper:o}={...(0,i.R)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,o,n)=>{n.d(o,{R:()=>r,x:()=>l});var t=n(6540);const i={},s=t.createContext(i);function r(e){const o=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function l(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(s.Provider,{value:o},e.children)}}}]);